{% extends "base.html" %}

{% block title %}Opportunities - SE Team Manager{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12 d-flex justify-content-between align-items-center">
        <h2><i class="bi bi-graph-up-arrow"></i> Opportunities</h2>
        <div>
            <button class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#importCsvModal">
                <i class="bi bi-upload"></i> Import CSV
            </button>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addOppModal">
                <i class="bi bi-plus-lg"></i> Add Opportunity
            </button>
        </div>
    </div>
</div>

<!-- Filters -->
<div class="card mb-4">
    <div class="card-body">
        <form method="get" class="row g-3">
            <div class="col-md-3">
                <label class="form-label">Stage</label>
                <select name="stage" class="form-select">
                    <option value="">All Stages</option>
                    {% for s in opportunity_stages %}
                    <option value="{{ s }}" {% if selected_stage == s %}selected{% endif %}>{{ s }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Team Member</label>
                <select name="member_id" class="form-select">
                    <option value="">All Members</option>
                    {% for member in team_members %}
                    <option value="{{ member.id }}" {% if selected_member == member.id %}selected{% endif %}>{{ member.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Product</label>
                <select name="product" class="form-select">
                    <option value="">All Products</option>
                    {% for p in products_list %}
                    <option value="{{ p }}" {% if selected_product == p %}selected{% endif %}>{{ p }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">POV Status</label>
                <select name="pov_status" class="form-select">
                    <option value="">All POV Statuses</option>
                    {% for ps in pov_statuses %}
                    <option value="{{ ps }}" {% if selected_pov_status == ps %}selected{% endif %}>{{ ps }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3 d-flex align-items-end">
                <button type="submit" class="btn btn-secondary me-2">Filter</button>
                <a href="{{ url_for('opportunities') }}" class="btn btn-outline-secondary">Clear</a>
            </div>
        </form>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover" id="oppTable">
                <thead>
                    <tr>
                        <th class="sortable" data-col="0" data-type="string" style="cursor:pointer;">Opportunity <i class="bi bi-arrow-down-up text-muted small"></i></th>
                        <th class="sortable" data-col="1" data-type="string" style="cursor:pointer;">Account <i class="bi bi-arrow-down-up text-muted small"></i></th>
                        <th class="sortable" data-col="2" data-type="number" style="cursor:pointer;">Stage <i class="bi bi-arrow-down-up text-muted small"></i></th>
                        <th class="sortable" data-col="3" data-type="number" style="cursor:pointer;">Conf <i class="bi bi-arrow-down-up text-muted small"></i></th>
                        <th class="sortable" data-col="4" data-type="number" style="cursor:pointer;">Value <i class="bi bi-arrow-down-up text-muted small"></i></th>
                        <th class="sortable" data-col="5" data-type="string" style="cursor:pointer;">Primary SE <i class="bi bi-arrow-down-up text-muted small"></i></th>
                        <th class="sortable" data-col="6" data-type="string" style="cursor:pointer;">Sales Rep <i class="bi bi-arrow-down-up text-muted small"></i></th>
                        <th class="sortable" data-col="7" data-type="string" style="cursor:pointer;">Products <i class="bi bi-arrow-down-up text-muted small"></i></th>
                        <th class="sortable" data-col="8" data-type="string" style="cursor:pointer;">POV <i class="bi bi-arrow-down-up text-muted small"></i></th>
                        <th class="sortable" data-col="9" data-type="date" style="cursor:pointer;">Close Date <i class="bi bi-arrow-down-up text-muted small"></i></th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for opp in opportunities %}
                    <tr>
                        <td data-sort-value="{{ opp.name.lower() }}">
                            <strong>
                                {% if opp.salesforce_link %}<a href="{{ opp.salesforce_link }}" target="_blank" style="color: #00008b;">{{ opp.name }}</a>{% else %}{{ opp.name }}{% endif %}
                            </strong>
                            {% if opp.updates|length > 2 %}
                            <span class="badge bg-info">{{ opp.updates|length - 1 }} updates</span>
                            {% endif %}
                        </td>
                        <td data-sort-value="{{ opp.account.lower() }}">{{ opp.account }}</td>
                        <td data-sort-value="{{ opp.stage }}"><span class="badge bg-{{ 'success' if opp.stage == '6' else 'primary' }}">{{ opp.stage }}</span></td>
                        <td data-sort-value="{{ opp.confidence or 0 }}">{{ opp.confidence or '-' }}</td>
                        <td data-sort-value="{{ opp.value }}">${{ '{:,.0f}'.format(opp.value) }}</td>
                        <td data-sort-value="{{ opp.team_member.name.lower() }}">{{ opp.team_member.name }}</td>
                        <td data-sort-value="{{ (opp.sales_rep or '').lower() }}">{{ opp.sales_rep or '-' }}</td>
                        <td data-sort-value="{{ (opp.products or '').lower() }}">{{ opp.products or '-' }}</td>
                        <td data-sort-value="{{ opp.pov_status or 'None' }}"><span class="badge bg-{{ 'success' if opp.pov_status == 'Tech Win' else 'primary' if opp.pov_status == 'Active' else 'info' if opp.pov_status == 'Completed' else 'secondary' }}">{{ opp.pov_status or 'None' }}</span></td>
                        <td data-sort-value="{{ opp.close_date.strftime('%Y-%m-%d') if opp.close_date else '9999-12-31' }}">{{ opp.close_date.strftime('%Y-%m-%d') if opp.close_date else '-' }}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-info" data-bs-toggle="modal" data-bs-target="#viewOppModal{{ opp.id }}">
                                <i class="bi bi-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#editOppModal{{ opp.id }}">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#commentOppModal{{ opp.id }}">
                                <i class="bi bi-chat"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteOppModal{{ opp.id }}">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="11" class="text-center text-muted">No opportunities found. Add one to get started!</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add Opportunity Modal -->
<div class="modal fade" id="addOppModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form action="{{ url_for('add_opportunity') }}" method="post">
                <div class="modal-header" style="background-color: #1a2332; border-top: 3px solid #f15822;">
                    <h5 class="modal-title" style="color: #fff; font-weight: 600;">Add Opportunity</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <h6 class="form-section-title">Opportunity Details</h6>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Account *</label>
                            <input type="text" name="account" class="form-control" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Opportunity *</label>
                            <input type="text" name="name" class="form-control" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Salesforce Link</label>
                        <input type="url" name="salesforce_link" class="form-control" placeholder="https://...">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Products</label>
                        <div class="d-flex flex-wrap gap-3">
                            {% for p in products_list %}
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="products" value="{{ p }}" id="add_prod_{{ p }}">
                                <label class="form-check-label" for="add_prod_{{ p }}">{{ p }}</label>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    <h6 class="form-section-title">Team & Value</h6>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Sales Rep</label>
                            <input type="text" name="sales_rep" class="form-control">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Primary SE *</label>
                            <select name="team_member_id" class="form-select" required>
                                <option value="">Select SE...</option>
                                {% for member in team_members %}<option value="{{ member.id }}">{{ member.name }}</option>{% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Opp Value ($)</label>
                            <input type="text" name="value" class="form-control currency-input" value="$0.00">
                        </div>
                    </div>
                    <h6 class="form-section-title">Pipeline</h6>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Stage (1-6)</label>
                            <select name="stage" class="form-select">
                                {% for s in opportunity_stages %}<option value="{{ s }}">{{ s }}</option>{% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Expected Close Date</label>
                            <input type="date" name="close_date" class="form-control">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Confidence (1-10)</label>
                            <select name="confidence" class="form-select">
                                <option value="">-</option>
                                {% for c in range(1, 11) %}<option value="{{ c }}">{{ c }}</option>{% endfor %}
                            </select>
                        </div>
                    </div>
                    <h6 class="form-section-title">Activities</h6>
                    <div class="row">
                        <div class="col-md-2 mb-3">
                            <label class="form-label">RFP</label>
                            <select name="rfp" class="form-select">
                                <option value="N">No</option>
                                <option value="Y">Yes</option>
                            </select>
                        </div>
                        <div class="col-md-2 mb-3">
                            <label class="form-label">Demo</label>
                            <select name="demo" class="form-select">
                                <option value="N">No</option>
                                <option value="Y">Yes</option>
                            </select>
                        </div>
                        <div class="col-md-2 mb-3">
                            <label class="form-label">POV</label>
                            <select name="pov_status" class="form-select">
                                {% for ps in pov_statuses %}<option value="{{ ps }}">{{ ps }}</option>{% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2 mb-3">
                            <label class="form-label">Competitive</label>
                            <div class="form-check mt-2">
                                <input class="form-check-input" type="checkbox" name="competitive" value="Y" id="add_competitive">
                                <label class="form-check-label" for="add_competitive">Yes</label>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Competitor</label>
                            <input type="text" name="competitive_notes" class="form-control" placeholder="Competitor name(s)">
                        </div>
                    </div>
                    <h6 class="form-section-title">Latest Update</h6>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Date</label>
                            <input type="date" name="latest_update_date" class="form-control">
                        </div>
                        <div class="col-md-8 mb-3">
                            <label class="form-label">Notes</label>
                            <textarea name="latest_update_notes" class="form-control" rows="2"></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Opportunity</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modals for each opportunity -->
{% for opp in opportunities %}
<!-- View Modal with Timeline -->
<div class="modal fade" id="viewOppModal{{ opp.id }}" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ opp.name }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <p><strong>Account:</strong> {{ opp.account }}</p>
                        <p><strong>Stage:</strong> <span class="badge bg-primary">{{ opp.stage }}</span></p>
                        <p><strong>Confidence:</strong> {{ opp.confidence or '-' }}/10</p>
                        <p><strong>Value:</strong> ${{ '{:,.0f}'.format(opp.value) }}</p>
                        <p><strong>Products:</strong> {{ opp.products or '-' }}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Primary SE:</strong> {{ opp.team_member.name }}</p>
                        <p><strong>Sales Rep:</strong> {{ opp.sales_rep or '-' }}</p>
                        <p><strong>Close Date:</strong> {{ opp.close_date.strftime('%Y-%m-%d') if opp.close_date else '-' }}</p>
                        <p><strong>RFP:</strong> {{ opp.rfp or 'N' }} | <strong>Demo:</strong> {{ opp.demo or 'N' }} | <strong>POV:</strong> {{ opp.pov_status or 'None' }}</p>
                        {% if opp.salesforce_link %}<p><strong>SF Link:</strong> <a href="{{ opp.salesforce_link }}" target="_blank">Open in Salesforce</a></p>{% endif %}
                    </div>
                </div>
                {% if opp.latest_update_notes %}
                <div class="card mb-3 bg-light">
                    <div class="card-body py-2">
                        <strong class="small">Latest Update{% if opp.latest_update_date %} ({{ opp.latest_update_date.strftime('%Y-%m-%d') }}){% endif %}:</strong>
                        <p class="mb-0 small">{{ opp.latest_update_notes }}</p>
                    </div>
                </div>
                {% endif %}
                <h6>History</h6>
                <div class="timeline">
                    {% for update in opp.updates|sort(attribute='created_at', reverse=True) %}
                    <div class="card mb-2">
                        <div class="card-body py-2">
                            <small class="text-muted">{{ update.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
                            {% if update.stage_from and update.stage_to %}
                            <p class="mb-0">Stage changed: <span class="badge bg-secondary">{{ update.stage_from }}</span> &rarr; <span class="badge bg-primary">{{ update.stage_to }}</span></p>
                            {% endif %}
                            {% if update.comment %}
                            <p class="mb-0">{{ update.comment }}</p>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Modal -->
<div class="modal fade" id="editOppModal{{ opp.id }}" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form action="{{ url_for('edit_opportunity', id=opp.id) }}" method="post">
                <div class="modal-header" style="background-color: #1a2332; border-top: 3px solid #f15822;">
                    <h5 class="modal-title" style="color: #fff; font-weight: 600;">Edit Opportunity</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <h6 class="form-section-title">Opportunity Details</h6>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Account *</label>
                            <input type="text" name="account" class="form-control" value="{{ opp.account }}" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Opportunity *</label>
                            <input type="text" name="name" class="form-control" value="{{ opp.name }}" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Salesforce Link</label>
                        <input type="url" name="salesforce_link" class="form-control" value="{{ opp.salesforce_link or '' }}" placeholder="https://...">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Products</label>
                        <div class="d-flex flex-wrap gap-3">
                            {% for p in products_list %}
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="products" value="{{ p }}" id="main_opp{{ opp.id }}_prod_{{ p }}" {% if opp.products and p in opp.products.split(',') %}checked{% endif %}>
                                <label class="form-check-label" for="main_opp{{ opp.id }}_prod_{{ p }}">{{ p }}</label>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    <h6 class="form-section-title">Team & Value</h6>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Sales Rep</label>
                            <input type="text" name="sales_rep" class="form-control" value="{{ opp.sales_rep or '' }}">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Primary SE *</label>
                            <select name="team_member_id" class="form-select" required>
                                {% for member in team_members %}<option value="{{ member.id }}" {% if opp.team_member_id == member.id %}selected{% endif %}>{{ member.name }}</option>{% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Opp Value ($)</label>
                            <input type="text" name="value" class="form-control currency-input" value="${{ '{:,.2f}'.format(opp.value) }}">
                        </div>
                    </div>
                    <h6 class="form-section-title">Pipeline</h6>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Stage (1-6)</label>
                            <select name="stage" class="form-select">
                                {% for s in opportunity_stages %}<option value="{{ s }}" {% if opp.stage == s %}selected{% endif %}>{{ s }}</option>{% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Expected Close Date</label>
                            <input type="date" name="close_date" class="form-control" value="{{ opp.close_date.strftime('%Y-%m-%d') if opp.close_date else '' }}">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Confidence (1-10)</label>
                            <select name="confidence" class="form-select">
                                <option value="">-</option>
                                {% for c in range(1, 11) %}<option value="{{ c }}" {% if opp.confidence == c %}selected{% endif %}>{{ c }}</option>{% endfor %}
                            </select>
                        </div>
                    </div>
                    <h6 class="form-section-title">Activities</h6>
                    <div class="row">
                        <div class="col-md-2 mb-3">
                            <label class="form-label">RFP</label>
                            <select name="rfp" class="form-select">
                                <option value="N" {% if opp.rfp != 'Y' %}selected{% endif %}>No</option>
                                <option value="Y" {% if opp.rfp == 'Y' %}selected{% endif %}>Yes</option>
                            </select>
                        </div>
                        <div class="col-md-2 mb-3">
                            <label class="form-label">Demo</label>
                            <select name="demo" class="form-select">
                                <option value="N" {% if opp.demo != 'Y' %}selected{% endif %}>No</option>
                                <option value="Y" {% if opp.demo == 'Y' %}selected{% endif %}>Yes</option>
                            </select>
                        </div>
                        <div class="col-md-2 mb-3">
                            <label class="form-label">POV</label>
                            <select name="pov_status" class="form-select">
                                {% for ps in pov_statuses %}<option value="{{ ps }}" {% if opp.pov_status == ps %}selected{% endif %}>{{ ps }}</option>{% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2 mb-3">
                            <label class="form-label">Competitive</label>
                            <div class="form-check mt-2">
                                <input class="form-check-input" type="checkbox" name="competitive" value="Y" id="edit_competitive_{{ opp.id }}" {% if opp.competitive == 'Y' %}checked{% endif %}>
                                <label class="form-check-label" for="edit_competitive_{{ opp.id }}">Yes</label>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Competitor</label>
                            <input type="text" name="competitive_notes" class="form-control" value="{{ opp.competitive_notes or '' }}" placeholder="Competitor name(s)">
                        </div>
                    </div>
                    <h6 class="form-section-title">Latest Update</h6>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Date</label>
                            <input type="date" name="latest_update_date" class="form-control" value="{{ opp.latest_update_date.strftime('%Y-%m-%d') if opp.latest_update_date else '' }}">
                        </div>
                        <div class="col-md-8 mb-3">
                            <label class="form-label">Notes</label>
                            <textarea name="latest_update_notes" class="form-control" rows="2">{{ opp.latest_update_notes or '' }}</textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Comment Modal -->
<div class="modal fade" id="commentOppModal{{ opp.id }}" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="{{ url_for('add_opportunity_comment', id=opp.id) }}" method="post">
                <div class="modal-header">
                    <h5 class="modal-title">Add Comment</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p><strong>{{ opp.name }}</strong> - {{ opp.account }}</p>
                    <div class="mb-3">
                        <label class="form-label">Comment *</label>
                        <textarea name="comment" class="form-control" rows="3" required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Comment</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Modal -->
<div class="modal fade" id="deleteOppModal{{ opp.id }}" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="{{ url_for('delete_opportunity', id=opp.id) }}" method="post">
                <div class="modal-header">
                    <h5 class="modal-title">Delete Opportunity</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete <strong>{{ opp.name }}</strong>?</p>
                    <p class="text-danger"><small>This will also delete all related updates and comments.</small></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Delete</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endfor %}

<!-- Import CSV Modal -->
<div class="modal fade" id="importCsvModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="{{ url_for('import_opportunities') }}" method="post" enctype="multipart/form-data">
                <div class="modal-header" style="background-color: #1a2332; border-top: 3px solid #f15822;">
                    <h5 class="modal-title" style="color: #fff; font-weight: 600;">Import Opportunities from CSV</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Upload a CSV file to bulk import opportunities. Required columns: <strong>name</strong>, <strong>account</strong>, <strong>se_name</strong>.</p>
                    <p><a href="{{ url_for('import_template') }}"><i class="bi bi-download"></i> Download Template</a> to see the expected format.</p>
                    <div class="mb-3">
                        <label class="form-label">CSV File *</label>
                        <input type="file" name="csv_file" class="form-control" accept=".csv" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Import</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    var table = document.getElementById('oppTable');
    if (!table) return;
    var headers = table.querySelectorAll('th.sortable');
    var currentCol = -1, ascending = true;

    headers.forEach(function(th) {
        th.addEventListener('click', function() {
            var col = parseInt(th.dataset.col);
            var type = th.dataset.type;
            if (currentCol === col) {
                ascending = !ascending;
            } else {
                currentCol = col;
                ascending = true;
            }
            headers.forEach(function(h) {
                h.querySelector('i').className = 'bi bi-arrow-down-up text-muted small';
            });
            th.querySelector('i').className = ascending ? 'bi bi-arrow-up small' : 'bi bi-arrow-down small';

            var tbody = table.querySelector('tbody');
            var rows = Array.from(tbody.querySelectorAll('tr'));
            rows.sort(function(a, b) {
                var aCell = a.cells[col], bCell = b.cells[col];
                if (!aCell || !bCell) return 0;
                var aVal = aCell.dataset.sortValue || '';
                var bVal = bCell.dataset.sortValue || '';
                if (type === 'number') {
                    aVal = parseFloat(aVal) || 0;
                    bVal = parseFloat(bVal) || 0;
                    return ascending ? aVal - bVal : bVal - aVal;
                }
                return ascending ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
            });
            rows.forEach(function(row) { tbody.appendChild(row); });
        });
    });
});
</script>
{% endblock %}
